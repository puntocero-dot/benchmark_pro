
import os
import json
from datetime import datetime
from price_monitor_v2.config.settings import CATEGORIAS_PRODUCTOS, COMPETITORS

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Monitor Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #111827; color: #f3f4f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #10B981; text-align: center; margin-bottom: 10px; }
        .timestamp { text-align: center; color: #9CA3AF; margin-bottom: 30px; font-size: 0.9em; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: #1F2937; padding: 20px; border-radius: 12px; border: 1px solid #374151; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card h3 { margin: 0; font-size: 0.9em; color: #9CA3AF; text-transform: uppercase; }
        .card .value { font-size: 1.8em; font-weight: bold; color: #F9FAFB; margin-top: 5px; }
        
        /* Comparison Table */
        .section-title { border-left: 4px solid #10B981; padding-left: 10px; margin: 40px 0 20px; font-size: 1.5em; }
        .table-container { overflow-x: auto; background: #1F2937; border-radius: 12px; border: 1px solid #374151; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #374151; }
        th { background-color: #374151; color: #D1D5DB; font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        
        .product-name { display: block; font-size: 0.9em; color: #D1D5DB; margin-top: 4px; }
        .price { font-weight: bold; font-size: 1.1em; color: #F3F4F6; }
        .best-price { color: #10B981; font-weight: 800; }
        .best-price::after { content: ' üî•'; }
        
        /* Promos */
        .promos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .promo-list { list-style: none; padding: 0; margin: 10px 0 0; }
        .promo-item { background: #374151; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; border-left: 3px solid #F59E0B; }
        
        footer { margin-top: 50px; text-align: center; color: #6B7280; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçó Price Monitor Dashboard</h1>
        <div class="timestamp">Actualizado: {timestamp}</div>
        
        <div class="stats-grid">
            <div class="card">
                <h3>Competidores Scaneados</h3>
                <div class="value">{competitors_count}</div>
            </div>
            <div class="card">
                <h3>Productos Totales</h3>
                <div class="value">{products_count}</div>
            </div>
            <div class="card">
                <h3>Categor√≠as</h3>
                <div class="value">{categories_count}</div>
            </div>
        </div>

        <h2 class="section-title">üìä Comparativa de Precios</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Categor√≠a</th>
                        {headers}
                    </tr>
                </thead>
                <tbody>
                    {rows}
                </tbody>
            </table>
        </div>
        
        <h2 class="section-title">üè∑Ô∏è Promociones Activas</h2>
        <div class="promos-grid">
            {promos_html}
        </div>
        
        <footer>Generated by Antigravity AI Price Monitor Pro V2</footer>
    </div>
</body>
</html>
"""

def generate_html_report(history):
    comp_data = history.get("competidores", {})
    if not comp_data:
        return

    # Prepare Headers
    competitor_names = [c["name"] for c in COMPETITORS if c.get("active")]
    headers_html = "".join([f"<th>{name}</th>" for name in competitor_names])
    
    # Prepare Data Rows
    rows_html = ""
    for cat_key, cat_conf in CATEGORIAS_PRODUCTOS.items():
        cat_name = cat_conf["nombre"]
        row_cells = f"<td>{cat_name}</td>"
        
        # Find prices for this category per competitor
        prices = []
        comp_cells = []
        
        for comp_name in competitor_names:
            cell_content = "-"
            price_val = float('inf')
            
            if comp_name in comp_data:
                products = comp_data[comp_name].get("productos_actuales", [])
                # Find product in this category with LOWEST price
                relevant = [p for p in products if p["categoria"] == cat_key]
                if relevant:
                    # Sort by price
                    best = min(relevant, key=lambda x: x["precio"])
                    price_val = best["precio"]
                    prices.append(price_val)
                    
                    cell_content = f"""
                    <div class="price-container">
                        <span class="price">${price_val:.2f}</span>
                        <span class="product-name">{best['nombre']}</span>
                    </div>
                    """
            
            comp_cells.append({"html": cell_content, "price": price_val})

        # Determine Best Price (min)
        min_price = min(prices) if prices else -1
        
        # Build Row HTML
        for cell in comp_cells:
            content = cell["html"]
            # Highlight if matches min_price (and is real price)
            if cell["price"] == min_price and min_price != float('inf'):
                content = content.replace('class="price"', 'class="price best-price"')
            
            row_cells += f"<td>{content}</td>"
            
        rows_html += f"<tr>{row_cells}</tr>"

    # Promos Section
    promos_html = ""
    total_products = 0
    
    for comp_name in competitor_names:
        if comp_name in comp_data:
            c_hist = comp_data[comp_name]
            total_products += c_hist.get("productos_detectados", 0)
            promos = c_hist.get("promociones_activas", [])
            
            if promos:
                list_items = "".join([f"<li class='promo-item'>{p.upper()}</li>" for p in promos])
                promos_html += f"""
                <div class="card">
                    <h3>{comp_name}</h3>
                    <ul class="promo-list">
                        {list_items}
                    </ul>
                </div>
                """
            else:
                 promos_html += f"""
                <div class="card">
                    <h3>{comp_name}</h3>
                    <div style="color: #6B7280; font-size: 0.9em; margin-top:10px;">Sin promociones detectadas</div>
                </div>
                """

    # Final Output
    html = HTML_TEMPLATE.format(
        timestamp=datetime.now().strftime("%d/%m/%Y %H:%M:%S"),
        competitors_count=len(competitor_names),
        products_count=total_products,
        categories_count=len(CATEGORIAS_PRODUCTOS),
        headers=headers_html,
        rows=rows_html,
        promos_html=promos_html
    )
    
    with open("dashboard.html", "w", encoding="utf-8") as f:
        f.write(html)
    print("   [Dashboard] dashboard.html generated successfully.")

